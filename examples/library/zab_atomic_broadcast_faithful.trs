protocol ZabAtomicBroadcastFaithful {
    params n, t, f, gst;
    resilience: n = 2*f + 1;

    adversary {
        model: omission;
        bound: f;
        timing: partial_synchrony;
        gst: gst;
        auth: signed;
        network: identity_selective;
        delivery: per_recipient;
        faults: per_recipient;
        equivocation: none;
        values: sign;
    }

    identity Replica: role key replica_key;

    message Proposal(epoch: nat, zxid: nat);
    message Ack(epoch: nat, zxid: nat);
    message Commit(epoch: nat, zxid: nat);

    role Replica {
        var decided: bool = false;
        var decision: bool = false;
        init propose;

        phase propose {
            when received distinct >= n-f Proposal(epoch=0, zxid=0) => {
                goto phase acked;
            }
        }

        phase acked {
            when received distinct >= n-f Ack(epoch=0, zxid=0) => {
                goto phase commit;
            }
        }

        phase commit {
            when received distinct >= n-f Commit(epoch=0, zxid=0) => {
                decision = true;
                decided = true;
                decide true;
                goto phase decided;
            }
        }

        phase decided {}
    }

    property agreement: agreement {
        forall p: Replica. forall q: Replica.
            (p.decided == true && q.decided == true) ==> (p.decision == q.decision)
    }
}
